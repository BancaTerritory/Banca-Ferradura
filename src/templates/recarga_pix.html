{% extends "base.html" %}

{% block title %}Recarga PIX - Banca Ferradura{% endblock %}

{% block content %}
<div class="container">
    <div class="card game-container">
        <div class="header-balance">
            <h2><i data-lucide="credit-card" style="vertical-align: middle;"></i> Recarga PIX</h2>
            {% if session.get("user_phone" ) %}
                <span class="balance-info">Saldo Atual: R$ {{ "%.2f"|format(session.get("user_credits", 0.0)) }}</span>
            {% endif %}
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash-message flash-{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% if session.get("user_phone") %}
            <div class="pix-container">
                <h3 style="text-align: center; margin-bottom: 30px; color: #e0e0e0;">
                    <i data-lucide="smartphone" style="vertical-align: middle;"></i> 
                    Escolha o valor para recarga
                </h3>

                <div class="valores-grid">
                    <div class="valor-card" onclick="selecionarValor(10)">
                        <div class="valor-amount">R$ 10,00</div>
                        <div class="valor-bonus">Recarga Mínima</div>
                    </div>
                    
                    <div class="valor-card" onclick="selecionarValor(20)">
                        <div class="valor-amount">R$ 20,00</div>
                        <div class="valor-bonus">Popular</div>
                    </div>
                    
                    <div class="valor-card valor-destaque" onclick="selecionarValor(50)">
                        <div class="valor-amount">R$ 50,00</div>
                        <div class="valor-bonus">+5% Bônus</div>
                    </div>
                    
                    <div class="valor-card" onclick="selecionarValor(100)">
                        <div class="valor-amount">R$ 100,00</div>
                        <div class="valor-bonus">+10% Bônus</div>
                    </div>
                    
                    <div class="valor-card" onclick="selecionarValor(200)">
                        <div class="valor-amount">R$ 200,00</div>
                        <div class="valor-bonus">+15% Bônus</div>
                    </div>
                    
                    <div class="valor-card valor-vip" onclick="selecionarValor(500)">
                        <div class="valor-amount">R$ 500,00</div>
                        <div class="valor-bonus">+20% Bônus VIP</div>
                    </div>
                </div>

                <div class="valor-personalizado">
                    <h4>Ou digite um valor personalizado:</h4>
                    <div class="input-group">
                        <span class="input-prefix">R$</span>
                        <input type="number" id="valorPersonalizado" placeholder="0,00" min="10" step="0.01">
                        <button onclick="selecionarValorPersonalizado()" class="btn-personalizado">
                            <i data-lucide="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal PIX -->
            <div id="modalPix" class="modal-pix" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i data-lucide="qr-code"></i> PIX Copia e Cola</h3>
                        <span class="close-modal" onclick="fecharModal()">&times;</span>
                    </div>
                    
                    <div class="pix-info">
                        <div class="valor-recarga">
                            <span class="label">Valor da Recarga:</span>
                            <span class="valor" id="valorSelecionado">R$ 0,00</span>
                        </div>
                        
                        <div class="pix-qr">
                            <div class="qr-placeholder">
                                <i data-lucide="qr-code" style="font-size: 80px; color: #666;"></i>
                                <p>QR Code PIX</p>
                            </div>
                        </div>
                        
                        <div class="pix-codigo">
                            <label>Código PIX Copia e Cola:</label>
                            <div class="codigo-container">
                                <input type="text" id="codigoPix" readonly>
                                <button onclick="copiarCodigo()" class="btn-copiar">
                                    <i data-lucide="copy"></i> Copiar
                                </button>
                            </div>
                        </div>
                        
                        <div class="pix-instrucoes">
                            <h4><i data-lucide="info"></i> Como pagar:</h4>
                            <ol>
                                <li>Abra o app do seu banco</li>
                                <li>Escolha a opção PIX</li>
                                <li>Selecione "Copia e Cola"</li>
                                <li>Cole o código acima</li>
                                <li>Confirme o pagamento</li>
                            </ol>
                        </div>
                        
                        <div class="pix-tempo">
                            <p><i data-lucide="clock"></i> Este PIX expira em: <span id="tempoExpiracao">15:00</span></p>
                        </div>
                        
                        <div class="pix-acoes">
                            <button onclick="verificarPagamento()" class="btn-verificar">
                                <i data-lucide="refresh-cw"></i> Verificar Pagamento
                            </button>
                            <button onclick="gerarNovoPix()" class="btn-novo">
                                <i data-lucide="rotate-ccw"></i> Gerar Novo PIX
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <p style="text-align:center; margin-top:30px;">
                <a href="{{ url_for("main.index") }}" class="auth-link">
                    <i data-lucide="arrow-left-circle" style="vertical-align: middle;"></i> Voltar para o Dashboard
                </a>
            </p>
        {% else %}
            <p style="text-align:center;">Você precisa estar logado para fazer recarga. 
                <a href="{{ url_for("auth.login_page") }}" class="auth-link">Faça login</a>.
            </p>
        {% endif %}
    </div>
</div>

<style>
.pix-container {
    max-width: 800px;
    margin: 0 auto;
}

.valores-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.valor-card {
    background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
    border: 2px solid #444;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.valor-card:hover {
    border-color: #ffd700;
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
}

.valor-destaque {
    border-color: #ffd700;
    background: linear-gradient(135deg, #2a2a2a 0%, #4a4a2a 100%);
}

.valor-vip {
    border-color: #ff6b6b;
    background: linear-gradient(135deg, #2a2a2a 0%, #4a2a2a 100%);
}

.valor-amount {
    font-size: 24px;
    font-weight: bold;
    color: #ffd700;
    margin-bottom: 8px;
}

.valor-bonus {
    font-size: 14px;
    color: #ccc;
    font-style: italic;
}

.valor-personalizado {
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    margin-top: 30px;
}

.valor-personalizado h4 {
    color: #e0e0e0;
    margin-bottom: 20px;
}

.input-group {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    max-width: 300px;
    margin: 0 auto;
}

.input-prefix {
    font-size: 18px;
    font-weight: bold;
    color: #ffd700;
}

#valorPersonalizado {
    flex: 1;
    padding: 12px;
    border: 2px solid #444;
    border-radius: 8px;
    background: #1a1a1a;
    color: #fff;
    font-size: 16px;
    text-align: center;
}

.btn-personalizado {
    background: #ffd700;
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 12px 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-personalizado:hover {
    background: #ffed4e;
    transform: scale(1.05);
}

.modal-pix {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #2a2a2a;
    border-radius: 15px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    border: 2px solid #ffd700;
}

.modal-header {
    background: #ffd700;
    color: #000;
    padding: 20px;
    border-radius: 13px 13px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 20px;
}

.close-modal {
    font-size: 24px;
    cursor: pointer;
    font-weight: bold;
}

.pix-info {
    padding: 25px;
}

.valor-recarga {
    text-align: center;
    margin-bottom: 25px;
    padding: 15px;
    background: #1a1a1a;
    border-radius: 8px;
}

.valor-recarga .label {
    display: block;
    color: #ccc;
    font-size: 14px;
    margin-bottom: 5px;
}

.valor-recarga .valor {
    font-size: 28px;
    font-weight: bold;
    color: #ffd700;
}

.pix-qr {
    text-align: center;
    margin-bottom: 25px;
}

.qr-placeholder {
    background: #1a1a1a;
    border: 2px dashed #444;
    border-radius: 8px;
    padding: 30px;
    color: #666;
}

.pix-codigo {
    margin-bottom: 25px;
}

.pix-codigo label {
    display: block;
    color: #e0e0e0;
    margin-bottom: 10px;
    font-weight: bold;
}

.codigo-container {
    display: flex;
    gap: 10px;
}

#codigoPix {
    flex: 1;
    padding: 12px;
    border: 2px solid #444;
    border-radius: 8px;
    background: #1a1a1a;
    color: #fff;
    font-family: monospace;
    font-size: 12px;
}

.btn-copiar {
    background: #28a745;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.btn-copiar:hover {
    background: #34ce57;
}

.pix-instrucoes {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.pix-instrucoes h4 {
    color: #ffd700;
    margin-bottom: 15px;
}

.pix-instrucoes ol {
    color: #ccc;
    padding-left: 20px;
}

.pix-instrucoes li {
    margin-bottom: 8px;
}

.pix-tempo {
    text-align: center;
    color: #ff6b6b;
    font-weight: bold;
    margin-bottom: 25px;
}

.pix-acoes {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.btn-verificar, .btn-novo {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: bold;
}

.btn-verificar {
    background: #007bff;
    color: white;
}

.btn-verificar:hover {
    background: #0056b3;
}

.btn-novo {
    background: #6c757d;
    color: white;
}

.btn-novo:hover {
    background: #545b62;
}

@media (max-width: 768px) {
    .valores-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    .valor-card {
        padding: 15px;
    }
    
    .valor-amount {
        font-size: 20px;
    }
    
    .modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .pix-acoes {
        flex-direction: column;
    }
}
</style>

<script>
let tempoExpiracao = 15 * 60; // 15 minutos em segundos
let intervalTimer;

function selecionarValor(valor) {
    gerarPix(valor);
}

function selecionarValorPersonalizado() {
    const valor = parseFloat(document.getElementById('valorPersonalizado').value);
    if (valor < 10) {
        alert('Valor mínimo para recarga é R$ 10,00');
        return;
    }
    if (valor > 5000) {
        alert('Valor máximo para recarga é R$ 5.000,00');
        return;
    }
    gerarPix(valor);
}

function gerarPix(valor) {
    // Simular geração de PIX (em produção, seria uma chamada para a API)
    const codigoPix = gerarCodigoPIXSimulado();
    
    document.getElementById('valorSelecionado').textContent = `R$ ${valor.toFixed(2).replace('.', ',')}`;
    document.getElementById('codigoPix').value = codigoPix;
    
    // Resetar timer
    tempoExpiracao = 15 * 60;
    iniciarTimer();
    
    // Mostrar modal
    document.getElementById('modalPix').style.display = 'flex';
}

function gerarCodigoPIXSimulado() {
    // Código PIX simulado (em produção seria gerado pela API do PodBank)
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let codigo = '00020126580014BR.GOV.BCB.PIX0136';
    for (let i = 0; i < 32; i++) {
        codigo += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    codigo += '5204000053039865802BR5925BANCA FERRADURA LTDA6009SAO PAULO62070503***6304';
    for (let i = 0; i < 4; i++) {
        codigo += Math.floor(Math.random() * 10);
    }
    return codigo;
}

function copiarCodigo() {
    const codigo = document.getElementById('codigoPix');
    codigo.select();
    codigo.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(codigo.value);
    
    const btn = document.querySelector('.btn-copiar');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i data-lucide="check"></i> Copiado!';
    btn.style.background = '#28a745';
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = '#28a745';
        lucide.createIcons();
    }, 2000);
}

function iniciarTimer() {
    clearInterval(intervalTimer);
    intervalTimer = setInterval(() => {
        const minutos = Math.floor(tempoExpiracao / 60);
        const segundos = tempoExpiracao % 60;
        document.getElementById('tempoExpiracao').textContent = 
            `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        
        if (tempoExpiracao <= 0) {
            clearInterval(intervalTimer);
            alert('PIX expirado! Gere um novo código.');
            fecharModal();
        }
        tempoExpiracao--;
    }, 1000);
}

function verificarPagamento() {
    // Simular verificação de pagamento (em produção seria uma chamada para API)
    const btn = document.querySelector('.btn-verificar');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i data-lucide="loader-2"></i> Verificando...';
    btn.disabled = true;
    
    setTimeout(() => {
        // Simular resposta aleatória
        const pago = Math.random() > 0.7; // 30% chance de estar pago
        
        if (pago) {
            alert('Pagamento confirmado! Seus créditos foram adicionados.');
            fecharModal();
            location.reload(); // Recarregar para atualizar saldo
        } else {
            alert('Pagamento ainda não identificado. Tente novamente em alguns instantes.');
        }
        
        btn.innerHTML = originalText;
        btn.disabled = false;
        lucide.createIcons();
    }, 2000);
}

function gerarNovoPix() {
    const valor = parseFloat(document.getElementById('valorSelecionado').textContent.replace('R$ ', '').replace(',', '.'));
    gerarPix(valor);
}

function fecharModal() {
    document.getElementById('modalPix').style.display = 'none';
    clearInterval(intervalTimer);
}

// Fechar modal clicando fora
document.getElementById('modalPix').addEventListener('click', function(e) {
    if (e.target === this) {
        fecharModal();
    }
});

// Inicializar ícones quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
});
</script>
{% endblock %}
